#!/bin/bash
echo -e "\n===== BEFORE S2I ASSEMBLE =====\n"

echo "# Backup composer.json"
cp /tmp/src/composer.json /tmp/composer.json.bak

echo -e "\n===== S2I ASSEMBLE =====\n"
/usr/libexec/s2i/assemble
rc=$?

if [ $rc -eq 0 ]; then
    echo -e "\n===== S2I ASSEMBLE SUCCESSFUL =====\n"

    echo "# Restore composer.json"
    mv /tmp/composer.json.bak /opt/app-root/src/composer.json

    echo "# Setup composer bin"
    mv /opt/app-root/src/composer.phar /usr/bin/composer
    chmod +x /usr/bin/composer

    if [[ ${COMPOSER_REPOSITORIES} ]]; then
        echo "# Setup additional Composer repositories"

        echo "${COMPOSER_AUTH}" > /opt/app-root/src/auth.json

        readarray -td "|" REPOSITORIES_LIST <<< "${COMPOSER_REPOSITORIES}"; declare -a REPOSITORIES_LIST;

        for REPO_NAME_TYPE_URL in "${REPOSITORIES_LIST[@]}"
        do
            yes | composer config repositories.$(echo "${REPO_NAME_TYPE_URL}" | xargs)
        done
    else
        echo "# No additional Composer repositories to add"
    fi

    if [[ ${COMPOSER_PACKAGES} ]]; then
        echo "# Install additional Composer packages"

        composer require -n ${COMPOSER_PACKAGES}
    else
        echo "# No additional Composer packages to install"
    fi
else
    echo -e "\n===== S2I ASSEMBLE FAILED =====\n"
fi

echo -e "\n===== S2I ASSEMBLE READY =====\n"

exit $rc
