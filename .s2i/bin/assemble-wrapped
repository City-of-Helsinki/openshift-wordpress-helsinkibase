#!/bin/bash
echo "===== BEFORE S2I ASSEMBLE ====="

if [[ ${COMPOSER_REPOSITORIES} ]]; then
    echo "# Setup additional Composer repositories"

    readarray -td "|" REPOSITORIES_LIST <<< "${COMPOSER_REPOSITORIES}"; declare -a REPOSITORIES_LIST;

    for REPO_NAME_TYPE_URL in "${REPOSITORIES_LIST[@]}"
    do
        php composer.phar config repositories.$(echo "${REPO_NAME_TYPE_URL}" | xargs)
    done
else
    echo "# No additional Composer repositories to add"
fi

if [[ ${COMPOSER_PACKAGES} ]]; then
    echo "# Install additional Composer packages"

    php composer.phar require "${COMPOSER_PACKAGES} --no-install"
else
    echo "# No additional Composer packages to install"
fi

echo "===== S2I ASSEMBLE ====="
/usr/libexec/s2i/assemble
rc=$?

if [ $rc -eq 0 ]; then
    echo "===== S2I ASSEMBLE SUCCESSFUL ====="

    echo "# Setup composer bin"
    mv /opt/app-root/src/composer.phar /usr/bin/composer
    chmod +x /usr/bin/composer
else
    echo "===== S2I ASSEMBLE FAILED ====="
fi

echo "===== S2I ASSEMBLE READY ====="

exit $rc
