#!/bin/bash

echo -e "\n===== BEFORE S2I RUN =====\n"

if ! wp core is-installed; then
    echo "# Setup default database tables"

    wp core install \
        --url="${WORDPRESS_TEMP_URL}" \
        --title="${WORDPRESS_SITE_TITLE}" \
        --admin_user="${WORDPRESS_ADMIN_EMAIL}" \
        --admin_email="${WORDPRESS_ADMIN_EMAIL}" \
        --admin_password="${WORDPRESS_ADMIN_TEMP_PASSWORD}" \
        --locale=${WORDPRESS_LOCALE} \
        --skip-email

    wp user reset-password "${WORDPRESS_ADMIN_EMAIL}" --skip-email
else
    echo "# Database tables available"
fi

echo "# Initializing postfix"
postconf -e "always_add_missing_headers = no"
postconf -e "maillog_file = /dev/stdout"
postconf -e "myhostname = wp-openshift-test.dev.hel.ninja"
postconf -e "mydomain = wp-openshift-test.dev.hel.ninja"
postconf -e "mydestination = localhost"
postconf -e "myorigin = wp-openshift-test"
postconf -e "relayhost = relayhel.fi:25"
postconf -e "smtp_use_tls = yes"
postconf -e "smtp_host_lookup = native,dns"
postconf -e "inet_protocols = all"
postconf -e "daemon_directory = /var/spool/postfix"

rm -f /var/spool/postfix/pid/master.pid
/usr/sbin/postfix -c /etc/postfix start-cfg

echo -e "\n===== S2I RUN =====\n"
exec /usr/libexec/s2i/run

echo -e "\n===== S2I RUN READY =====\n"
